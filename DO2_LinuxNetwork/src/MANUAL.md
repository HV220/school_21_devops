# Сети в Linux
Настройка сетей в Linux на виртуальных машинах.
##  Содержание
   1. [Инструмент ipcalc](#part-1-инструмент-ipcalc)
   2. [Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами)
   3. [Утилита iperf3](#part-3-утилита-iperf3)
   4. [Сетевой экран](#part-4-сетевой-экран)
   5. [Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети)
   6. [Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-ip-с-помощью-dhcp)
   7. [NAT](#part-7-nat)
## Part 1. Инструмент **ipcalc**
использованные команды:
* `ipcalc 192.167.38.54/13`
![ipcalc 192.167.38.54/13](./images/part10.png)
* `ipcalc 192.167.38.54 255.255.255.0`
![ipcalc 192.167.38.54 255.255.255.0](./images/part11.png)
* `ipcalc 192.167.38.54/15`
![ipcalc 192.167.38.54 255.255.255.0](./images/part12.png)
* `ipcalc 192.167.38.54 255.255.255.240`
![ipcalc 192.167.38.54 255.255.255.240](./images/part13.png)
* `ipcalc 12.167.38.4/8 && ipcalc 12.167.38.4 255.255.0.0 && ipcalc 12.167.38.4 255.255.254.0`
![ipcalc 12.167.38.4/8 && ipcalc 12.167.38.4 255.255.0.0 && ipcalc 12.167.38.4 255.255.254.0](./images/part14.png)
* `ipcalc 12.167.38.4/4`
![ipcalc 12.167.38.4/4](./images/part14.png)
* только 127.0.0.2, так как ip хоста 127.0.0.1 
* публичные:
* 134.43.0.2, 192.168.4.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1
* частные:
* 10.0.0.45, 172.20.250.4, 172.16.255.255, 10.10.10.10
* возможны:
* 10.10.0.2, 10.10.10.10
## Part 2. Статическая маршрутизация между двумя машинами
использованные команды:
* `ip a`
![ip a user-1](./images/part20.png)
*  измененный 00-installer-config.yaml
![user-2, user-1 00-installer-config](./images/part28.png)
* `sudo netplan apply`
* `sudo ip r add 192.168.100.10 dev enp0s3`
* `sudo ip r add 172.24.116.8 dev enp0s3`
* `ping -c 5 192.168.100.10`
* `ping -c 5 172.24.116.8`
![user-1, user-2](./images/part24.png)
* статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml
![user-2 static](./images/part28.png)
## Part 3. Утилита **iperf3**
Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps
* 8 Mbps = 1 MB/s
* 100 MB/s = 819200 Kbps
* 1 Gbps = 1024 Mbps

использованные команды:
* `iperf -s`
* `iperf -c 192.168.100.10`
![iperf3](./images/part30.png)
## Part 4. Сетевой экран
Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2
использованные команды:
* `chmod +x /etc/firewall.sh && /etc/firewall.sh`
![firewall.sh](./images/part40.png)
проверка на соответствие заданию: соответствует
![firewall.sh](./images/part41.png)
## Part 5. Статическая маршрутизация сети
### 5.1. Настройка адресов машин
* Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.
![1,2 machine](./images/part42.png)
![3,4 machine](./images/part43.png)
![5 machine](./images/part44.png)
* Перезапустить сервис сети. `sudo netplan apply`
* Если ошибок нет, то командой `ip -4` a проверить, что адрес машины задан верно.
![1,2 machine](./images/part45.png)
![3,4 machine](./images/part46.png)
![5 machine](./images/part47.png)
* Скрин пинга `ws22` с `ws21`.
![ping ws22 ws21](./images/part48.png)
* Скрин пинга `r1` с `ws11`.
![ping r1 ws11](./images/part49.png)
### 5.2. Включение переадресации IP-адресов.
* Для включения переадресации IP, выполните команду на роутерах: `sysctl -w net.ipv4.ip_forward=1` При таком подходе переадресация не будет работать после перезагрузки системы. Cкрин с вызовом и выводом использованной команды.
![ip_forward r1,r2](./images/part50.png)
* Откройте файл `/etc/sysctl.conf` и добавьте в него следующую строку: `net.ipv4.ip_forward = 1` При использовании этого подхода, IP-переадресация включена на постоянной основе.
![ip_forward r1,r2](./images/part51.png)
### 5.3. Установка маршрута по-умолчанию
* Пример вывода команды ip r после добавления шлюза:
```
default via 10.10.0.1 dev eth0
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.2
```
* Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 [ip роутера] в файле конфигураций. Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации
![ipr r1,2](./images/part52.png)
![ipr r1,2](./images/part53.png)
* Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: `tcpdump -tn -i eth1`
![ping ws11 r2](./images/part54.png)
### 5.4. Добавление статических маршрутов
* Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций, перезапустим сервис сети и вызовем команду ip r:
![ip r](./images/part55.png)
* Вызов команд ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0 на ws11:
![ip r](./images/part56.png)
* Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, поскольку он является адресом сети и доступен без шлюза.
### 5.5. Построение списка маршрутизаторов
* Запуск на r1 команды дампа tcpdump -tnv -i ent0 и построение списка маршрутизаторов на пути от ws11 до ws21 при помощи утилиты traceroute
![tcpdump -tnv -i ent0](./images/part57.png)
* Для определения промежуточных маршрутизаторов traceroute отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первая серия пакетов отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit».
* Процесс повторяется до тех пор, пока пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.
* На оконечном хосте IP-датаграмма с TTL = 1 не отбрасывается и не вызывает ICMP-сообщения типа срок истёк, а должна быть отдана приложению. Достижение пункта назначения определяется следующим образом: отсылаемые traceroute датаграммы содержат UDP-пакет с заведомо неиспользуемым номером порта на адресуемом хосте. Номер порта будет равен 33434 + (максимальное количество транзитных участков до узла) — 1. В пункте назначения UDP-модуль, получая подобные датаграммы, возвращает ICMP-сообщения об ошибке «порт недоступен». Таким образом, чтобы узнать о завершении работы, программе traceroute достаточно обнаружить, что поступило ICMP-сообщение об ошибке этого типа
### 5.6. Использование протокола ICMP при маршрутизации
* Запуск на r1 перехвата сетевого трафика, проходящего через eth0 с помощью команды tcpdump -n -i eth0 icmp и пинг с ws11 несуществующего IP ping -c 1 10.30.0.111:
![IP ping -c 1 10.30.0.111](./images/part58.png)
## Part 6. Динамическая настройка IP с помощью **DHCP**
* Содержание файла /etc/dhcp/dhcpd.conf для r2 с конфигурацией службы DHCP
* Содержание файла /etc/resolf.conf для r2 с конфигурацией службы DHCP
![DHCP](./images/part59.png)
* Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес. Также пропинговать ws22 с ws21.
![PING](./images/part60.png)
* Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true
* Содержание файла /etc/dhcp/dhcpd.conf для r1 с конфигурацией службы DHCP
* Содержание файла /etc/resolf.conf для r1 с конфигурацией службы DHCP
![DHCP](./images/part61.png)
* Запрос обновления ip адреса с ws21
* Команда sudo dhclient -r enp0s3 освобождает текущий адрес интерфейса enp0s3. Команда sudo dhclient enp0s3 задает новый адрес указанному интерфейсу.
![dhclient](./images/part62.png)
## Part 7. **NAT**
* Содержание файла /etc/apache2/ports.conf на ws22 и r2 (строка Listen 80 изменена на Listen 0.0.0.0:80):
![apache2](./images/part63.png)
* Запустить веб-сервер Apache командой service apache2 start на ws22 и r1:
![apache2](./images/part64.png)
* Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 правила
![apache2](./images/part65.png)
* Проверить соединение между ws22 и r1 командой ping
![apache2](./images/part66.png)
* Разрешить маршрутизацию всех пакетов протокола ICMP
![ICMP](./images/part67.png)
* Проверка соединения между ws22 и r1 командой ping
![ICMP](./images/part68.png)